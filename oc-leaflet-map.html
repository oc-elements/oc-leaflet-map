<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="leaflet-js.html">
<link rel="import" href="leaflet-css.html">

<dom-module id="oc-leaflet-map">
    <template>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.0/dist/leaflet.css"/>
        <link rel="import" type="css" href="https://unpkg.com/leaflet@1.3.0/dist/leaflet.css"/>
        <style is="leaflet-css">
            :host {
                display: block;
            }

            :host #myMap {
                height: 100%;
                width: 100%;
                z-index: 1;
            }
        </style>

        <div id="myMap" style="height: 200px"></div>
    </template>

    <script>
		/**
		 * `oc-leaflet-map`
		 * Polymer Leaflet Map
		 *
		 * @customElement
		 * @polymer
		 * @demo demo/index.html
		 */
		class OcLeafletMap extends Polymer.Element {
			static get is() {
				return 'oc-leaflet-map';
			}

			static get properties() {
				return {
					/**
					 * The `latitude` attribute sets the map center.
					 *
					 * @attribute latitude
					 * @type number
					 */
					latitude: {
						type: Number,
						value: 51,
						reflectToAttribute: true,
						notify: true,
						observer: '_setMarker',
					},
					/**
					 * The `longitude` attribute sets the map center.
					 *
					 * @attribute longitude
					 * @type number
					 */
					longitude: {
						type: Number,
						value: 0,
						reflectToAttribute: true,
						notify: true,
						observer: '_setMarker',
					},

					_map: {
						type: Object
					},

					_marker: {
						type: Object
					}
				};
			}

			ready() {
				super.ready();
				// Default image path, for the markers
				L.Icon.Default.imagePath = '/images/';
				// Default location JHB/PTA area
				this._map = L.map(this.$.myMap).setView([-26, 28], 8);

				L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
					attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
				}).addTo(this._map);

				// This is small hack, because in Polymer I could not find a way for the css to be loaded before the js.
				setTimeout(() => {
					this._map.invalidateSize()
				}, 100);

				// Map events
				this._map.on('click', this._onMapClick.bind(this));

				// try to get the current location of the user
				this._map.locate({setView: true, maxZoom: 16});
			}

			// On map click. For now this will only set a maker
			_onMapClick(e) {
				this.latitude = e.latlng.lat;
				this.longitude = e.latlng.lng;
				this._setMarker();
			}

			_setMarker() {
				if (!this._map) return;
				const latLng = L.latLng(this.latitude, this.longitude);

				if (!this._marker) {
					this._marker = L.marker(latLng, {iconUrl: 'marker-icon.png'}).addTo(this._map);
				} else {
					this._marker.setLatLng(latLng);
				}

				this._map.panTo(latLng)
			}
		}

		window.customElements.define(OcLeafletMap.is, OcLeafletMap);
    </script>
</dom-module>
